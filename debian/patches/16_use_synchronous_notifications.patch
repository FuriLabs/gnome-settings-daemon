Description: Use synchronous notifications when they are supported
Author: ?

--- a/plugins/media-keys/gsd-media-keys-manager.c
+++ b/plugins/media-keys/gsd-media-keys-manager.c
@@ -56,6 +56,8 @@
 
 #include <libupower-glib/upower.h>
 
+#include <libnotify/notify.h>
+
 #define GSD_DBUS_PATH "/org/gnome/SettingsDaemon"
 #define GSD_DBUS_NAME "org.gnome.SettingsDaemon"
 #define GSD_MEDIA_KEYS_DBUS_PATH GSD_DBUS_PATH "/MediaKeys"
@@ -135,6 +137,10 @@ struct GsdMediaKeysManagerPrivate
         GCancellable    *cancellable;
 
         guint            start_idle_id;
+
+        /* Ubuntu notifications */
+        NotifyNotification *volume_notification;
+        NotifyNotification *brightness_notification;
 };
 
 static void     gsd_media_keys_manager_class_init  (GsdMediaKeysManagerClass *klass);
@@ -145,6 +151,116 @@ G_DEFINE_TYPE (GsdMediaKeysManager, gsd_
 
 static gpointer manager_object = NULL;
 
+#define NOTIFY_CAP_PRIVATE_SYNCHRONOUS "x-canonical-private-synchronous"
+#define NOTIFY_CAP_PRIVATE_ICON_ONLY "x-canonical-private-icon-only"
+#define NOTIFY_HINT_TRUE "true"
+
+typedef struct {
+        GsdMediaKeysManager *manager;
+        MediaKeyType type;
+        guint old_percentage;
+        
+} GsdBrightnessActionData;
+
+static const char *volume_icons[] = {
+        "notification-audio-volume-muted",
+        "notification-audio-volume-low",
+        "notification-audio-volume-medium",
+        "notification-audio-volume-high",
+        NULL
+};
+
+static const char *brightness_icons[] = {
+        "notification-display-brightness-off",
+	"notification-display-brightness-low",
+	"notification-display-brightness-medium",
+	"notification-display-brightness-high",
+	"notification-display-brightness-full",
+        NULL
+};
+
+static const char *
+calculate_icon_name (gint value, const char **icon_names)
+{
+        value = CLAMP (value, 0, 100);
+        gint length = g_strv_length (icon_names);
+        gint s = (length - 1) * value / 100 + 1;
+        s = CLAMP (s, 1, length - 1);
+
+        return icon_names[s];
+}
+
+static gboolean
+ubuntu_osd_notification_is_supported (void)
+{
+        GList *caps;
+        gboolean has_cap;
+
+        caps = notify_get_server_caps ();
+        has_cap = (g_list_find_custom (caps, NOTIFY_CAP_PRIVATE_SYNCHRONOUS, (GCompareFunc) g_strcmp0) != NULL);
+        g_list_foreach (caps, (GFunc) g_free, NULL);
+        g_list_free (caps);
+
+        return has_cap;
+}
+
+static gboolean
+ubuntu_osd_notification_show_icon (const char *icon,
+                                   const char *hint)
+{
+        if (!ubuntu_osd_notification_is_supported ())
+                return FALSE;
+
+        NotifyNotification *notification = notify_notification_new (" ", "", icon);
+        notify_notification_set_hint_string (notification, NOTIFY_CAP_PRIVATE_SYNCHRONOUS, hint);
+        notify_notification_set_hint_string (notification, NOTIFY_CAP_PRIVATE_ICON_ONLY, NOTIFY_HINT_TRUE);
+
+        gboolean res = notify_notification_show (notification, NULL);
+        g_object_unref (notification);
+
+        return res;
+}
+
+static gboolean
+ubuntu_osd_notification_show_volume (GsdMediaKeysManager *manager,
+                                     gint value,
+                                     gboolean muted)
+{
+        if (!ubuntu_osd_notification_is_supported ())
+                return FALSE;
+
+        if (!manager->priv->volume_notification) {
+                manager->priv->volume_notification = notify_notification_new (" ", "", NULL);
+                notify_notification_set_hint_string (manager->priv->volume_notification, NOTIFY_CAP_PRIVATE_SYNCHRONOUS, "volume");
+        }
+
+        value = CLAMP (value, -1, 101);
+        const char *icon = muted ? volume_icons[0] : calculate_icon_name (value, volume_icons);
+        notify_notification_set_hint_int32 (manager->priv->volume_notification, "value", (muted && value > 0) ? 0 : value);
+        notify_notification_update (manager->priv->volume_notification, " ", "", icon);
+
+        return notify_notification_show (manager->priv->volume_notification, NULL);
+}
+
+static gboolean
+ubuntu_osd_notification_show_brightness (GsdMediaKeysManager *manager,
+                                         gint value)
+{
+        if (!ubuntu_osd_notification_is_supported ())
+                return FALSE;
+
+        if (!manager->priv->brightness_notification) {
+                manager->priv->brightness_notification = notify_notification_new (" ", "", NULL);
+                notify_notification_set_hint_string (manager->priv->brightness_notification, NOTIFY_CAP_PRIVATE_SYNCHRONOUS, "brightness");
+        }
+
+        value = CLAMP (value, -1, 101);
+        const char *icon = value <= 0 ? brightness_icons[0] : calculate_icon_name (value, brightness_icons);
+        notify_notification_set_hint_int32 (manager->priv->brightness_notification, "value", value);
+        notify_notification_update (manager->priv->brightness_notification, " ", "", icon);
+
+        return notify_notification_show (manager->priv->brightness_notification, NULL);
+}
 
 static void
 init_screens (GsdMediaKeysManager *manager)
@@ -563,11 +679,13 @@ do_eject_action (GsdMediaKeysManager *ma
         }
 
         /* Show the dialogue */
-        dialog_init (manager);
-        gsd_media_keys_window_set_action_custom (GSD_MEDIA_KEYS_WINDOW (manager->priv->dialog),
-                                                 "media-eject-symbolic",
-                                                 FALSE);
-        dialog_show (manager);
+        if (!ubuntu_osd_notification_show_icon ("notification-device-eject", "Eject")) {
+                dialog_init (manager);
+                gsd_media_keys_window_set_action_custom (GSD_MEDIA_KEYS_WINDOW (manager->priv->dialog),
+                                                         "media-eject-symbolic",
+                                                         FALSE);
+                dialog_show (manager);
+        }
 
         /* Clean up the drive selection and exit if no suitable
          * drives are found */
@@ -590,11 +708,13 @@ do_eject_action (GsdMediaKeysManager *ma
 static void
 do_touchpad_osd_action (GsdMediaKeysManager *manager, gboolean state)
 {
-        dialog_init (manager);
-        gsd_media_keys_window_set_action_custom (GSD_MEDIA_KEYS_WINDOW (manager->priv->dialog),
-                                                 state ? "touchpad-enabled" : "touchpad-disabled",
-                                                 FALSE);
-        dialog_show (manager);
+        if (!ubuntu_osd_notification_show_icon ((!state) ? "touchpad-enabled" : "touchpad-disabled", "Touchpad")) {
+                dialog_init (manager);
+                gsd_media_keys_window_set_action_custom (GSD_MEDIA_KEYS_WINDOW (manager->priv->dialog),
+                                                        state ? "touchpad-enabled" : "touchpad-disabled",
+                                                        FALSE);
+                dialog_show (manager);
+        }
 }
 
 static void
@@ -621,12 +741,13 @@ do_touchpad_action (GsdMediaKeysManager
 static void
 update_dialog (GsdMediaKeysManager *manager,
                guint vol,
-               guint max_vol,
                gboolean muted,
                gboolean sound_changed,
                gboolean quiet)
 {
-        vol = (int) (100 * (double) vol / (double) max_vol);
+        if (ubuntu_osd_notification_show_volume (manager, vol, muted))
+                goto done;
+
         vol = CLAMP (vol, 0, 100);
 
         dialog_init (manager);
@@ -637,12 +758,26 @@ update_dialog (GsdMediaKeysManager *mana
                                           GSD_MEDIA_KEYS_WINDOW_ACTION_VOLUME);
         dialog_show (manager);
 
-        if (quiet == FALSE && sound_changed != FALSE && muted == FALSE)
-                ca_gtk_play_for_widget (manager->priv->dialog, 0,
+done:
+        if (quiet == FALSE && sound_changed != FALSE && muted == FALSE) {
+                GtkWidget *window;
+                if (!manager->priv->dialog) {
+                        window = gtk_window_new (GTK_WINDOW_TOPLEVEL);
+                        gtk_window_set_screen (GTK_WINDOW (window), manager->priv->current_screen);
+                        gtk_widget_realize (window);
+
+                } else {
+                        window = manager->priv->dialog;
+                }
+                ca_gtk_play_for_widget (window, 0,
                                         CA_PROP_EVENT_ID, "audio-volume-change",
                                         CA_PROP_EVENT_DESCRIPTION, "volume changed through key press",
                                         CA_PROP_APPLICATION_ID, "org.gnome.VolumeControl",
                                         NULL);
+
+                if (!manager->priv->dialog)
+                        gtk_widget_destroy(window);
+        }
 }
 
 static void
@@ -651,7 +786,7 @@ do_sound_action (GsdMediaKeysManager *ma
                  gboolean             quiet)
 {
         gboolean old_muted, new_muted;
-        guint old_vol, new_vol, max_vol, norm_vol_step;
+        guint old_vol, new_vol, max_vol, norm_vol_step, osd_vol;
         gboolean sound_changed;
 
         if (manager->priv->stream == NULL)
@@ -697,7 +832,14 @@ do_sound_action (GsdMediaKeysManager *ma
                 }
         }
 
-        update_dialog (manager, new_vol, max_vol, new_muted, sound_changed, quiet);
+        if (type == VOLUME_DOWN_KEY && old_vol == 0 && old_muted)
+                osd_vol = -1;
+        else if (type == VOLUME_UP_KEY && old_vol == max_vol && !old_muted)
+                osd_vol = 101;
+        else
+                osd_vol = (int) (100 * (double) new_vol / (double) max_vol);    
+
+        update_dialog (manager, osd_vol, new_muted, sound_changed, quiet);
 }
 
 static void
@@ -973,8 +1115,11 @@ static const GDBusInterfaceVTable interf
 
 static gboolean
 do_multimedia_player_action (GsdMediaKeysManager *manager,
+                             const char          *icon,
                              const char          *key)
 {
+        if (icon != NULL)
+                ubuntu_osd_notification_show_icon (icon, key);
         return gsd_media_player_key_pressed (manager, key);
 }
 
@@ -1263,7 +1408,8 @@ update_screen_cb (GObject             *s
         GError *error = NULL;
         guint percentage;
         GVariant *new_percentage;
-        GsdMediaKeysManager *manager = GSD_MEDIA_KEYS_MANAGER (user_data);
+        GsdBrightnessActionData *data = (GsdBrightnessActionData *) user_data;
+        GsdMediaKeysManager *manager = data->manager;
 
         new_percentage = g_dbus_proxy_call_finish (G_DBUS_PROXY (source_object),
                                                    res, &error);
@@ -1271,22 +1417,68 @@ update_screen_cb (GObject             *s
                 g_warning ("Failed to set new screen percentage: %s",
                            error->message);
                 g_error_free (error);
+                g_free (data);
                 return;
         }
 
         /* update the dialog with the new value */
         g_variant_get (new_percentage, "(u)", &percentage);
-        dialog_init (manager);
-        gsd_media_keys_window_set_action_custom (GSD_MEDIA_KEYS_WINDOW (manager->priv->dialog),
-                                                 "display-brightness-symbolic",
-                                                 TRUE);
-        gsd_media_keys_window_set_volume_level (GSD_MEDIA_KEYS_WINDOW (manager->priv->dialog),
-                                                percentage);
-        dialog_show (manager);
+
+        guint osd_percentage;
+        if (data->old_percentage == 100 && data->type == SCREEN_BRIGHTNESS_UP_KEY)
+                osd_percentage = 101;
+        else if (data->old_percentage == 0 && data->type == SCREEN_BRIGHTNESS_DOWN_KEY)
+                osd_percentage = -1;
+        else
+                osd_percentage = percentage;
+
+        if (!ubuntu_osd_notification_show_brightness (manager, osd_percentage)) {
+                dialog_init (manager);
+                gsd_media_keys_window_set_action_custom (GSD_MEDIA_KEYS_WINDOW (manager->priv->dialog),
+                                                         "display-brightness-symbolic",
+                                                         TRUE);
+                gsd_media_keys_window_set_volume_level (GSD_MEDIA_KEYS_WINDOW (manager->priv->dialog),
+                                                        percentage);
+                dialog_show (manager);
+        }
+        g_free (data);
         g_variant_unref (new_percentage);
 }
 
 static void
+do_screen_brightness_action_real (GObject       *source_object,
+                                  GAsyncResult  *res,
+                                  gpointer       user_data)
+{
+        GsdBrightnessActionData *data = (GsdBrightnessActionData *) user_data;
+        GsdMediaKeysManager *manager = data->manager;
+        GError *error = NULL;
+
+        GVariant *old_percentage = g_dbus_proxy_call_finish (G_DBUS_PROXY (source_object),
+                                                             res, &error);
+        if (old_percentage == NULL) {
+                g_warning ("Failed to get old screen percentage: %s", error->message);
+                g_error_free (error);
+                g_free (data);
+                return;
+        }
+
+        g_variant_get (old_percentage, "(u)", &data->old_percentage);
+
+        /* call into the power plugin */
+        g_dbus_proxy_call (manager->priv->power_screen_proxy,
+                           data->type == SCREEN_BRIGHTNESS_UP_KEY ? "StepUp" : "StepDown",
+                           NULL,
+                           G_DBUS_CALL_FLAGS_NONE,
+                           -1,
+                           NULL,
+                           update_screen_cb,
+                           data);
+
+        g_variant_unref (old_percentage);
+}
+
+static void
 do_screen_brightness_action (GsdMediaKeysManager *manager,
                              MediaKeyType type)
 {
@@ -1296,15 +1488,18 @@ do_screen_brightness_action (GsdMediaKey
                 return;
         }
 
-        /* call into the power plugin */
+        GsdBrightnessActionData *data = g_new0 (GsdBrightnessActionData, 1);
+        data->manager = manager;
+        data->type = type;
+
         g_dbus_proxy_call (manager->priv->power_screen_proxy,
-                           type == SCREEN_BRIGHTNESS_UP_KEY ? "StepUp" : "StepDown",
+                           "GetPercentage",
                            NULL,
                            G_DBUS_CALL_FLAGS_NONE,
                            -1,
                            NULL,
-                           update_screen_cb,
-                           manager);
+                           do_screen_brightness_action_real,
+                           data);
 }
 
 static void
@@ -1489,23 +1684,23 @@ do_action (GsdMediaKeysManager *manager,
                 execute (manager, "gcalctool", FALSE, FALSE);
                 break;
         case PLAY_KEY:
-                return do_multimedia_player_action (manager, "Play");
+                return do_multimedia_player_action (manager, NULL, "Play");
         case PAUSE_KEY:
-                return do_multimedia_player_action (manager, "Pause");
+                return do_multimedia_player_action (manager, NULL, "Pause");
         case STOP_KEY:
-                return do_multimedia_player_action (manager, "Stop");
+                return do_multimedia_player_action (manager, NULL, "Stop");
         case PREVIOUS_KEY:
-                return do_multimedia_player_action (manager, "Previous");
+                return do_multimedia_player_action (manager, NULL, "Previous");
         case NEXT_KEY:
-                return do_multimedia_player_action (manager, "Next");
+                return do_multimedia_player_action (manager, NULL, "Next");
         case REWIND_KEY:
-                return do_multimedia_player_action (manager, "Rewind");
+                return do_multimedia_player_action (manager, NULL, "Rewind");
         case FORWARD_KEY:
-                return do_multimedia_player_action (manager, "FastForward");
+                return do_multimedia_player_action (manager, NULL, "FastForward");
         case REPEAT_KEY:
-                return do_multimedia_player_action (manager, "Repeat");
+                return do_multimedia_player_action (manager, NULL, "Repeat");
         case RANDOM_KEY:
-                return do_multimedia_player_action (manager, "Shuffle");
+                return do_multimedia_player_action (manager, NULL, "Shuffle");
         case VIDEO_OUT_KEY:
         case VIDEO_OUT2_KEY:
                 do_video_out_action (manager, timestamp);
@@ -1804,6 +1999,18 @@ gsd_media_keys_manager_stop (GsdMediaKey
                 priv->connection = NULL;
         }
 
+        if (priv->volume_notification != NULL) {
+                notify_notification_close (priv->volume_notification, NULL);
+                g_object_unref (priv->volume_notification);
+                priv->volume_notification = NULL;
+        }
+
+        if (priv->brightness_notification != NULL) {
+                notify_notification_close (priv->brightness_notification, NULL);
+                g_object_unref (priv->brightness_notification);
+                priv->brightness_notification = NULL;
+        }
+
         need_flush = FALSE;
         gdk_error_trap_push ();
 
