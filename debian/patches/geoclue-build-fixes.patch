From 4faa5581f6bb568fa5d60bea533f0df4eaf5c5ed Mon Sep 17 00:00:00 2001
From: Tim Lunn <tim@feathertop.org>
Date: Wed, 1 Oct 2014 07:42:06 +1000
Subject: [PATCH] disable build of new datetime panel if geoclue-2.0 is not
 available

---
 configure.ac        | 25 +++++++++++++++----------
 plugins/Makefile.am |  7 ++++++-
 2 files changed, 21 insertions(+), 11 deletions(-)

diff --git a/configure.ac b/configure.ac
index c42ea8b..a52ace8 100644
--- a/configure.ac
+++ b/configure.ac
@@ -234,18 +234,23 @@ dnl ---------------------------------------------------------------------------
 AC_CHECK_LIBM
 AC_SUBST(LIBM)
 
-PKG_CHECK_MODULES(DATETIME,
-        geoclue-2.0 >= $GEOCLUE_REQUIRED_VERSION
-	geocode-glib-1.0 >= $GEOCODE_GLIB_REQUIRED_VERSION
-	gweather-3.0 >= $LIBGWEATHER_REQUIRED_VERSION
-	polkit-gobject-1 >= $POLKIT_REQUIRED_VERSION
-)
+PKG_CHECK_MODULES(GEOCLUE2, geoclue-2.0,  have_geoclue="yes", have_geoclue="no")
+if test "x$have_geoclue" = "xyes"; then
 
-GEOCLUE_DBUS_INTERFACE_XML=`pkg-config --variable=dbus_interface geoclue-2.0`
-if test "x$GEOCLUE_DBUS_INTERFACE_XML" = "x"; then
-	AC_MSG_ERROR([Cannot find dbus_interface variable in geoclue-2.0.pc])
+    PKG_CHECK_MODULES(DATETIME,
+        geoclue-2.0 >= $GEOCLUE_REQUIRED_VERSION
+        geocode-glib-1.0 >= $GEOCODE_GLIB_REQUIRED_VERSION
+        gweather-3.0 >= $LIBGWEATHER_REQUIRED_VERSION
+        polkit-gobject-1 >= $POLKIT_REQUIRED_VERSION
+    )
+
+    GEOCLUE_DBUS_INTERFACE_XML=`pkg-config --variable=dbus_interface geoclue-2.0`
+    if test "x$GEOCLUE_DBUS_INTERFACE_XML" = "x"; then
+	    AC_MSG_ERROR([Cannot find dbus_interface variable in geoclue-2.0.pc])
+    fi
+    AC_SUBST(GEOCLUE_DBUS_INTERFACE_XML)
 fi
-AC_SUBST(GEOCLUE_DBUS_INTERFACE_XML)
+AM_CONDITIONAL(HAVE_GEOCLUE2, test x$have_geoclue = xyes)
 
 dnl ---------------------------------------------------------------------------
 dnl - wacom (disabled for s390/s390x and non Linux platforms)
diff --git a/plugins/Makefile.am b/plugins/Makefile.am
index 7bb01f0..7bd261d 100644
--- a/plugins/Makefile.am
+++ b/plugins/Makefile.am
@@ -6,7 +6,6 @@ enabled_plugins =	\
 	clipboard	\
 	color		\
 	cursor		\
-	datetime	\
 	dummy		\
 	power		\
 	housekeeping    \
@@ -28,6 +27,12 @@ else
 disabled_plugins += smartcard
 endif
 
+if HAVE_GEOCLUE2
+enabled_plugins += datetime
+else
+disabled_plugins += datetime
+endif
+
 if HAVE_GUDEV
 enabled_plugins += orientation
 else
-- 
2.1.0


